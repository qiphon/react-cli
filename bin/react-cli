#!/usr/bin/env node

const { print, commander } = require('../utils')
const shell = require('shelljs')
const inquire = require('inquirer')
// const envinfo = require('envinfo');
const fs = require('fs')
const spin = require('ora')
const childProcess = require('child_process')
const { tmpdir } = require('os')
const { stdout, stderr } = require('process')
const { resolve } = require('path')

// get input argv
const { argv } = process
// save project info
let project = {}

commander(argv.slice(2), [
    {
        command: ['-c', 'create'],
        option: '[projectName]',
        description: 'åˆ›å»ºä¸€ä¸ªæ–°é¡¹ç›®',
        action(name) {
            project = {
                ...project, 
                name,
                dir: `${process.cwd()}/${name||''}`,
            }
            createApp(project)
            // if (!name) {
            //     form(
            //         [{
            //             type: "text",
            //             message: 'è¯·è¾“å…¥é¡¹ç›®åç§° ğŸ‘‰ ',
            //             name: 'name'
            //         }]
            //     )
            //     .then(({ name }) => {
            //         createApp({ ...project, name })
            //     })
            // } else {
            //     createApp({ ...project, name })
            // }
        }
    },
    {
        command: ['-i', 'info'],
        description: 'è·å–ç³»ç»Ÿå½“å‰ç³»ç»Ÿçš„ç›¸å…³ä¿¡æ¯',
        action() {
            // è·å–æŒ‡å®šçš„ç³»ç»Ÿä¿¡æ¯
            // envinfo.run(
            //     // {
            //     //     System: ['OS', 'CPU'],
            //     //     Binaries: ['Node', 'Yarn', 'npm'],
            //     //     Browsers: ['Chrome', 'Firefox', 'Safari'],
            //     // },
            //     // { json: true, showNotFound: true }
            // ).then(env => console.log(env));
            shell.exec('npx envinfo')
            process.exit(0)
        }
    },
    {
        command: ['-v', 'version'],
        description: 'å±•ç¤ºå½“å‰è„šæ‰‹æ¶ç‰ˆæœ¬',
        action(option) {
            print.hello()
        }
    },
])

function createApp({ name, dir }) {
    // const useYarn = shell.exec('yarn --version', {silent: true}).stdout
    if (!name) {
        // console.log('no name')
        let dirArr = dir.split('/')
        name = dirArr[dirArr.length - 1] 
        if(!name){
            dirArr.pop()
            name = dirArr[dirArr.length -1]
        }
        dir = dirArr.join('/')
        project = {
            ...project,
            name,
            dir
        }
        // console.log(project, 22, dirArr);return;
        return isCanUseDir(project)
    }
    var r = shell.exec(`ls -d ${dir}`, {silent:true}).stdout
    if(r) {
        // dir is exist
        return isCanUseDir(project)
    }else{
        // create dir
        shell.mkdir(dir);
        cloneProject()
    }
}

/**
 * @fileoverview å’Œç”¨æˆ·çš„äº¤äº’
 * @param {object[]}  arr 
 */
function form(arr) {
    return new Promise(resolve=>{
        inquire.prompt(arr).then(obj => {
            resolve(obj)
        })
        .catch(err => {
            print.error(err)
            process.exit(-1)
        })
    })
}
/**
 * @fileoverview å¤„ç†å½“å‰ç›®å½•
 */
function isCanUseDir({dir:path, name}) {
    let isEmpty = shell.exec(`ls ${path}`, {silent: true}).stdout
    // console.log(isEmpty,  ' is empty', project); return;
    if(isEmpty && !name){
        // console.log(`not empty & no name`)
        print.error(`
            \n å½“å‰ç›®å½•éç©ºï¼Œè¯·é€‰æ‹©ä¸€ä¸ªç©ºç›®å½• \n 
            ä¾‹å¦‚ï¼šusage: react-cli <projectName> \n
            for example: react-cli myapp \n
            for more options: react-cli -h
        `)
        process.exit(-1);
    }
    else if(isEmpty && name){
        // console.log('not empty & has name')
        form({
            type: 'confirm',
            name: 'isRMAll',
            message: 'è¿™ä¸ªæ–‡ä»¶éç©ºï¼Œæ˜¯å¦è¦åˆ é™¤è¿™ä¸ªæ–‡ä»¶å¤¹ä¸­çš„æ‰€æœ‰å†…å®¹ï¼Ÿ'
        })
        .then(({isRMAll})=>{
            if(isRMAll){
                shell.exec(`rm -rf ${path}`)
                let r = shell.mkdir(path)
                return cloneProject()
            }else{
                form(
                    [{
                        type: "text",
                        message: 'è¯·é‡æ–°è¾“å…¥é¡¹ç›®åç§° ğŸ‘‰ ',
                        name: 'name'
                    }]
                )
                .then(({ name }) => {
                    project = {
                        ...project,
                        dir: `${process.cwd()}/${name||''}`,
                        name
                    }
                    createApp(project)
                })
            }
        })
    }
    else{
        // console.log('empty')
        return cloneProject()
        console.log(isEmpty, 'empty', path)
    }
}

/**
 * @fileoverview å¼€å§‹å…‹éš†é¡¹ç›®
 */
function cloneProject() {
    let {dir, name} = project
    // let spinner = spin(`å¼€å§‹ä¸‹è½½æ¨¡æ¿ ...`).start();
    // æ¨¡æ¿ä¸´æ—¶ä¸‹è½½åœ°å€
    let tmp = dir + '/.tmp.zip'
    // é€‰æ‹©æ¨¡æ¿
    form([
        {
            type: 'list',
            name: 'platform',
            choices: ['pc', 'mobile'],
            message: 'é€‰æ‹©è¦ä½¿ç”¨çš„å¹³å°'
        },
        {
            type: 'list',
            name: 'data',
            choices: ['mobx', 'redux'],
            message: 'è¯·é€‰æ‹©è¦ä½¿ç”¨çš„æ•°æ®ä»“åº“'
        }
    ]).then(({platform, data})=>{
        console.log(platform, data)
    });return;
    childShell({
        shell: `curl -SsLo ${tmp} ${getTemplate('pc-mobx')}`
    })
    .then(({err, stdout, stderr})=>{
        // console.log(err, stdout)
        if(!err){
            spinner.succeed('æ¨¡æ¿ä¸‹è½½å®Œæˆï¼Œå¼€å§‹è§£å‹ã€‚')
            spinner = spin('å¼€å§‹è§£å‹...')
            return childShell({
                shell: `unzip -o ${tmp} -d ${dir}`
            })
        }
    })
    .then(({err, stdout, stderr})=>{
        // console.log(err, stdout)
        if(!err){
            spinner.succeed('è§£å‹å®Œæˆã€‚')
            return childShell({
                shell: `rm -rf ${tmp}`
            })    
        }
    })
    .then(({err, stdout, stderr})=>{
        // console.log(err, stdout)
        if(!err){
            // spinner.succeed('è§£å‹å®Œæˆã€‚')
            return childShell({
                shell: `ls ${dir}`
            })    
        }
    })
    .then(({err, stdout, stderr})=>{
        // console.log(err, stdout, 'å·²ç»è·å–åˆ°å½“å‰çš„æ–‡ä»¶å')
        let tmpDir = dir + '/' + stdout.replace('\n', '')
        if(!err){
            // spinner.succeed('è§£å‹å®Œæˆã€‚')
            return childShell({
                shell: `mv ${tmpDir}/* ${dir} & rm -rf ${dir}/${stdout}`
            })    
        }
    })
    .then(({err, stdout, stderr})=>{
        if(!err){
            shell.sed(`${dir}/package.json`, /"name":\s"(.*)"/, '$0')
            print.log(`
                \nğŸ˜›é¡¹ç›®ä¸‹è½½å®Œæˆï¼
                \nè¿è¡Œ yarn & yarn start å¯åŠ¨
            `)
            // process.chdir(dir)
        }
    })
    // childProcess.exec(
    //     `curl -SsLo ${tmp} ${getTemplate('pc-mobx')}`,
    //     function (err, stdout, stderr) {
    //         console.log(err, stdout, stderr, 'res') 
    //         if(err){
    //             // console.log('clone fail')
    //             spinner.stop()
    //             print.error(`é¡¹ç›®æ„å»ºå¤±è´¥ï¼Œè¯·æ£€æŸ¥å½“å‰ç½‘ç»œï¼Œ\næˆ–æ‰‹åŠ¨å…‹éš†é¡¹ç›®
    //             `)
    //             process.exit(-1)
    //         }else{
    //             // console.log('clone success')
    //             spinner.succeed(`é¡¹ç›® ${name} åˆ›å»ºå®Œæˆ`)
    //         }
    //         process.exit(0)
    //     }
    // )
    // console.log(project, 'clone start')
}
function childShell({
    shell,
    cb
}) {
    return new Promise(resolve=>
    childProcess.exec(shell, (err, stdout, stderr)=> resolve({err, stdout, stderr})))
}
function getTemplate(name) {
    let obj = {
        'pc-mobx': `https://github.com/qiphon/react-webpack4-mobx/archive/v1.0.zip`,
        'pc-redux': '',
        'mobile-mobx': '',
        'mobile-redux': ''
    }
    return obj[name] || ''
}